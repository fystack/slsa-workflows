name: Docker Build with SLSA L3 Provenance

on:
  workflow_call:
    inputs:
      image-name:
        description: 'Full Docker image name (e.g., azzurriii/apex-api)'
        required: true
        type: string
      context-path:
        description: 'Build context path relative to repository root'
        required: true
        type: string
      dockerfile:
        description: 'Path to Dockerfile relative to context'
        required: true
        type: string
      platforms:
        description: 'Target platforms (comma-separated)'
        required: false
        type: string
        default: 'linux/amd64'
      build-args:
        description: 'Build arguments (newline-separated KEY=VALUE pairs)'
        required: false
        type: string
        default: ''
      registry:
        description: 'Container registry (dockerhub, ghcr, gcr)'
        required: false
        type: string
        default: 'dockerhub'
      enable-sbom:
        description: 'Generate SBOM attestation'
        required: false
        type: boolean
        default: true
      private-repository:
        description: 'Allow private repos to post to public transparency log'
        required: false
        type: boolean
        default: false
    secrets:
      registry-username:
        description: 'Registry username'
        required: true
      registry-password:
        description: 'Registry password or token'
        required: true
    outputs:
      image-digest:
        description: 'SHA256 digest of the built image'
        value: ${{ jobs.build.outputs.digest }}
      image-uri:
        description: 'Full image URI with digest'
        value: ${{ jobs.build.outputs.image-uri }}

permissions:
  contents: read

jobs:
  build:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write  # Required for OIDC token
    outputs:
      digest: ${{ steps.build.outputs.digest }}
      image-uri: ${{ steps.uri.outputs.image-uri }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for accurate provenance

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:v0.13.0
            network=host

      - name: Log in to registry
        uses: docker/login-action@v3
        with:
          registry: ${{ inputs.registry == 'ghcr' && 'ghcr.io' || inputs.registry == 'gcr' && 'gcr.io' || 'docker.io' }}
          username: ${{ secrets.registry-username }}
          password: ${{ secrets.registry-password }}

      - name: Extract metadata
        id: meta
        run: |
          VERSION="${GITHUB_REF_NAME}"
          SHORT_SHA="${GITHUB_SHA:0:7}"
          BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          # Construct full image name with registry prefix
          if [[ "${{ inputs.registry }}" == "ghcr" ]]; then
            FULL_IMAGE="ghcr.io/${{ inputs.image-name }}"
          elif [[ "${{ inputs.registry }}" == "gcr" ]]; then
            FULL_IMAGE="gcr.io/${{ inputs.image-name }}"
          else
            FULL_IMAGE="${{ inputs.image-name }}"
          fi

          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "short-sha=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "build-date=${BUILD_DATE}" >> $GITHUB_OUTPUT
          echo "full-image=${FULL_IMAGE}" >> $GITHUB_OUTPUT
          echo "commit-sha=${GITHUB_SHA}" >> $GITHUB_OUTPUT

      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v6
        with:
          context: ${{ inputs.context-path }}
          file: ${{ inputs.context-path }}/${{ inputs.dockerfile }}
          platforms: ${{ inputs.platforms }}
          push: true
          tags: |
            ${{ steps.meta.outputs.full-image }}:${{ steps.meta.outputs.version }}
            ${{ steps.meta.outputs.full-image }}:${{ steps.meta.outputs.short-sha }}
            ${{ steps.meta.outputs.full-image }}:latest
          build-args: |
            VERSION=${{ steps.meta.outputs.version }}
            VCS_REF=${{ steps.meta.outputs.commit-sha }}
            BUILD_DATE=${{ steps.meta.outputs.build-date }}
            ${{ inputs.build-args }}
          labels: |
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.version=${{ steps.meta.outputs.version }}
            org.opencontainers.image.created=${{ steps.meta.outputs.build-date }}
          cache-from: type=registry,ref=${{ steps.meta.outputs.full-image }}:buildcache
          cache-to: type=registry,ref=${{ steps.meta.outputs.full-image }}:buildcache,mode=max
          sbom: false  # Disable buildkit SBOM, generate with Syft and attest with Cosign instead
          provenance: false  # Disable buildkit provenance, use SLSA generator instead

      - name: Output image URI
        id: uri
        run: |
          echo "image-uri=${{ steps.meta.outputs.full-image }}@${{ steps.build.outputs.digest }}" >> $GITHUB_OUTPUT

  # SLSA L3 Provenance Generation (Isolated Job)
  provenance:
    name: Generate SLSA Provenance
    needs: [build]
    permissions:
      actions: read
      id-token: write
      packages: write
      contents: read
    uses: slsa-framework/slsa-github-generator/.github/workflows/generator_container_slsa3.yml@v2.0.0
    with:
      image: ${{ inputs.image-name }}
      digest: ${{ needs.build.outputs.digest }}
      private-repository: ${{ inputs.private-repository }}
    secrets:
      registry-username: ${{ secrets.registry-username }}
      registry-password: ${{ secrets.registry-password }}

  # Sign image with Cosign (keyless)
  sign:
    name: Sign Image with Cosign
    runs-on: ubuntu-latest
    needs: [build, provenance]
    permissions:
      id-token: write  # Required for OIDC signing
      packages: write  # Required to push signatures
    steps:
      - name: Install Cosign
        uses: sigstore/cosign-installer@v3.5.0

      - name: Log in to registry
        uses: docker/login-action@v3
        with:
          registry: ${{ inputs.registry == 'ghcr' && 'ghcr.io' || inputs.registry == 'gcr' && 'gcr.io' || 'docker.io' }}
          username: ${{ secrets.registry-username }}
          password: ${{ secrets.registry-password }}

      - name: Sign image with keyless Cosign
        run: |
          cosign sign --yes \
            ${{ inputs.image-name }}@${{ needs.build.outputs.digest }}

      - name: Generate and attest SBOM
        if: ${{ inputs.enable-sbom }}
        run: |
          # Install Syft for SBOM generation
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin

          # Generate SBOM in SPDX format
          syft ${{ inputs.image-name }}@${{ needs.build.outputs.digest }} \
            -o spdx-json \
            --file sbom.spdx.json

          # Attest the SBOM with Cosign
          cosign attest --yes \
            --predicate sbom.spdx.json \
            --type spdx \
            ${{ inputs.image-name }}@${{ needs.build.outputs.digest }}
